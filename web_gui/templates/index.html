<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Mars Data Telekomunikasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --dark-bg: #050b18;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 242, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(188, 19, 254, 0.05) 0%, transparent 40%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }
        .status-on { color: var(--neon-blue); text-shadow: 0 0 8px rgba(0, 242, 255, 0.5); }
        .status-off { color: #ef4444; text-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
        .card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { 
            transform: translateY(-5px); 
            border-color: var(--neon-blue);
        }
        pre { background: #0a0f1d; color: var(--neon-blue); border: 1px solid rgba(0, 242, 255, 0.1); font-size: 10px; line-height: 1.2; }
        .progress-bar { height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple)); transition: width 0.5s ease; }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-8 rounded-3xl w-full max-w-md space-y-6 border border-blue-500/30">
            <div class="text-center">
                <h2 class="text-2xl font-orbitron text-white mb-2">ACCESS LOCKED</h2>
                <p class="text-slate-400 text-xs tracking-widest">PT MARS DATA TELEKOMUNIKASI</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="login-password" placeholder="ENTER ACCESS PASSWORD" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-center text-white focus:outline-none focus:border-blue-500 font-orbitron tracking-widest">
                <button onclick="attemptLogin()" id="login-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-orbitron rounded-xl transition shadow-[0_0_20px_rgba(37,99,235,0.3)]">UNLOCK SYSTEM</button>
                <p id="login-error" class="text-red-500 text-[10px] text-center hidden">INVALID ACCESS KEY</p>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-8 rounded-3xl w-full max-w-md space-y-6 border border-purple-500/30">
            <div class="text-center">
                <h2 class="text-2xl font-orbitron text-white mb-2">SECURITY UPDATE</h2>
                <p class="text-slate-400 text-xs tracking-widest">CHANGE ACCESS PASSWORD</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="new-password" placeholder="NEW PASSWORD" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-center text-white focus:outline-none focus:border-purple-500 font-orbitron">
                <input type="password" id="confirm-password" placeholder="CONFIRM NEW PASSWORD" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-center text-white focus:outline-none focus:border-purple-500 font-orbitron">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closePasswordModal()" class="py-3 bg-slate-800 hover:bg-slate-700 text-white font-orbitron rounded-xl transition">CANCEL</button>
                    <button onclick="submitNewPassword()" class="py-3 bg-purple-600 hover:bg-purple-500 text-white font-orbitron rounded-xl transition">UPDATE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Digtest Result Modal -->
    <div id="dig-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-8 rounded-3xl w-full max-w-2xl space-y-6 border border-blue-500/30">
            <div class="flex justify-between items-center border-b border-white/10 pb-4">
                <div>
                    <h2 class="text-2xl font-orbitron text-white">QUERY RESULT</h2>
                    <p id="dig-modal-subtitle" class="text-blue-400 text-[10px] tracking-widest uppercase">DEEP INSPECTION SUCCESS</p>
                </div>
                <button onclick="closeDigModal()" class="text-slate-400 hover:text-white transition p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="relative">
                <pre id="dig-modal-result" class="max-h-[400px] overflow-y-auto rounded-xl p-6 text-sm font-mono leading-relaxed border border-white/5 bg-black/40"></pre>
                <div class="absolute top-4 right-4 animate-pulse">
                    <span class="w-2 h-2 bg-blue-500 rounded-full inline-block"></span>
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="closeDigModal()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-orbitron rounded-xl transition shadow-lg shadow-blue-900/20">CLOSE RESULT</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col lg:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-white rounded-full p-1 flex items-center justify-center overflow-hidden shadow-[0_0_20px_rgba(255,255,255,0.1)]">
                    <img src="/static/img/logo_mars.jpeg" alt="MARS Logo" onerror="this.src='https://api.dicebear.com/7.x/initials/svg?seed=MARS&backgroundColor=003399'" class="w-full h-full object-contain">
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold font-orbitron tracking-wider text-white">PT MARS DATA TELEKOMUNIKASI</h1>
                    <div class="flex items-center gap-4 mt-1">
                        <p class="text-blue-400 font-medium tracking-widest text-xs">DNS MARS DATA TELEKOMUNIKASI</p>
                        <button onclick="openPasswordModal()" class="text-[9px] text-slate-500 hover:text-purple-400 font-orbitron border border-slate-800 px-2 py-0.5 rounded transition">CHANGE PWD</button>
                        <button onclick="logout()" class="text-[9px] text-slate-500 hover:text-red-400 font-orbitron border border-slate-800 px-2 py-0.5 rounded transition">LOGOUT</button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 w-full lg:w-auto">
                <div class="glass p-3 rounded-xl min-w-[110px]">
                    <span class="text-[10px] uppercase text-slate-400 block mb-1">CPU</span>
                    <div class="flex items-end gap-1"><span id="metric-cpu" class="text-xl font-orbitron text-white">0</span><span class="text-xs text-slate-500 mb-1">%</span></div>
                    <div class="progress-bar mt-2"><div id="bar-cpu" class="progress-fill" style="width: 0%"></div></div>
                </div>
                <div class="glass p-3 rounded-xl min-w-[110px]">
                    <span class="text-[10px] uppercase text-slate-400 block mb-1">RAM</span>
                    <div class="flex items-end gap-1"><span id="metric-ram" class="text-xl font-orbitron text-white">0</span><span class="text-xs text-slate-500 mb-1">%</span></div>
                    <div class="progress-bar mt-2"><div id="bar-ram" class="progress-fill" style="width: 0%"></div></div>
                </div>
                <div class="glass p-3 rounded-xl min-w-[110px]">
                    <span class="text-[10px] uppercase text-slate-400 block mb-1">DNS</span>
                    <div class="flex items-end gap-1"><span id="metric-perf" class="text-xl font-orbitron text-white">0</span><span class="text-xs text-slate-500 mb-1">%</span></div>
                    <div class="progress-bar mt-2"><div id="bar-perf" class="progress-fill" style="width: 0%"></div></div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Left Column: Status & Actions -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Status -->
                <div class="glass p-5 rounded-2xl space-y-4">
                    <h2 class="text-sm font-orbitron text-blue-400 border-b border-white/10 pb-2">SYSTEM STATUS</h2>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-400">DNSMASQ</span><span id="status-dnsmasq" class="text-xs font-orbitron">...</span></div>
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-400">UNBOUND</span><span id="status-unbound" class="text-xs font-orbitron">...</span></div>
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-400">GUARDIAN</span><span id="status-guardian" class="text-xs font-orbitron">...</span></div>
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-400">DDoS PROT</span><span id="status-security" class="text-xs font-orbitron">...</span></div>
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-400">NAT INTCP</span><span id="status-iptables" class="text-xs font-orbitron">...</span></div>
                    </div>
                </div>

                <!-- Control Center -->
                <div class="glass p-5 rounded-2xl space-y-3">
                    <h2 class="text-sm font-orbitron text-blue-400 border-b border-white/10 pb-2">CONTROL CENTER</h2>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="doAction('restart_dnsmasq')" class="text-left px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/5 rounded-xl transition group">
                            <span class="block text-[10px] text-slate-500 font-orbitron">SERVICE</span><span class="text-xs font-bold text-white">RESTART DNSMASQ</span>
                        </button>
                        <button onclick="doAction('restart_unbound')" class="text-left px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/5 rounded-xl transition group">
                            <span class="block text-[10px] text-slate-500 font-orbitron">SERVICE</span><span class="text-xs font-bold text-white">RESTART UNBOUND</span>
                        </button>
                        <button onclick="doAction('malware_shield')" class="text-left px-4 py-3 bg-red-900/20 hover:bg-red-900/40 border border-red-500/30 rounded-xl transition group">
                            <span class="block text-[10px] text-red-400 font-orbitron">PROTECTION</span><span class="text-xs font-bold text-white">MALWARE SHIELD</span>
                        </button>
                    </div>
                </div>

                <!-- Upstream DNS -->
                <div class="glass p-5 rounded-2xl space-y-3">
                    <h2 class="text-sm font-orbitron text-blue-400 border-b border-white/10 pb-2">UPSTREAM DNS</h2>
                    <div class="space-y-2">
                        <input type="text" id="dns-ip-input" placeholder="e.g. 8.8.8.8" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-white focus:outline-none focus:border-blue-500">
                        <button onclick="changeDnsIp()" class="w-full py-2 bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 rounded-lg text-[10px] font-orbitron text-white transition">UPDATE UPSTREAM</button>
                    </div>
                </div>

                <!-- Documentation -->
                <div class="glass p-5 rounded-2xl space-y-3">
                    <h2 class="text-sm font-orbitron text-purple-400 border-b border-white/10 pb-2">DOCUMENTATION</h2>
                    <div class="grid grid-cols-1 gap-2">
                        <a href="/api/manual/html" target="_blank" class="text-left px-4 py-3 bg-purple-900/20 hover:bg-purple-900/40 border border-purple-500/30 rounded-xl transition group flex flex-col">
                            <span class="block text-[10px] text-purple-400 font-orbitron">READ ONLINE</span>
                            <span class="text-xs font-bold text-white">SYSTEM MANUAL (HTML)</span>
                        </a>
                        <a href="/api/manual/pdf" class="text-left px-4 py-3 bg-blue-900/20 hover:bg-blue-900/40 border border-blue-500/30 rounded-xl transition group flex flex-col">
                            <span class="block text-[10px] text-blue-400 font-orbitron">DOWNLOAD</span>
                            <span class="text-xs font-bold text-white">PDF VERSION</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Traffic & Logs -->
            <div class="lg:col-span-2 space-y-6">
                <div class="glass p-6 rounded-2xl h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-orbitron text-white">TRAFFIC ANALYSIS</h2>
                        <span class="text-[10px] text-blue-400 animate-pulse">‚óè LIVE MONITORING</span>
                    </div>
                    <div class="h-[320px]"><canvas id="trafficChart"></canvas></div>
                </div>

                <div class="glass p-6 rounded-2xl hidden" id="guardian-logs-container">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-orbitron text-cyan-400">GUARDIAN AUTO-DEFENSE</h2>
                        <span class="text-[10px] text-cyan-500 animate-pulse">SHIELD ACTIVE</span>
                    </div>
                    <pre id="guardian-logs" class="max-h-[100px] overflow-y-auto rounded-lg p-3 text-cyan-400 border-cyan-900/50 bg-cyan-950/20"></pre>
                </div>

                <div class="glass p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-orbitron text-white">SYSTEM LOGS</h2>
                        <button onclick="fetchLogs()" class="text-[10px] text-blue-400 hover:underline">REFRESH LOGS</button>
                    </div>
                    <pre id="logs-content" class="h-[150px] overflow-y-auto rounded-lg p-3">Waiting for logs...</pre>
                </div>

                <!-- Global Whitelist (Moved for better visibility) -->
                <div class="glass p-6 rounded-2xl space-y-4">
                    <div class="flex justify-between items-center border-b border-white/10 pb-2">
                        <h2 class="text-sm font-orbitron text-cyan-400">GLOBAL WHITELIST</h2>
                        <span class="text-[9px] text-slate-500">IPs here bypass all security blocks</span>
                    </div>
                    <div class="space-y-3">
                        <textarea id="whitelist-input" placeholder="1.2.3.4&#10;192.168.1.0/24" class="w-full h-32 bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-xs text-cyan-400 font-mono focus:outline-none focus:border-cyan-500"></textarea>
                        <button onclick="updateWhitelist()" class="w-full py-3 bg-cyan-600/20 hover:bg-cyan-600/40 border border-cyan-500/30 rounded-xl text-xs font-orbitron text-white transition">APPLY & SAVE WHITELIST</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="doAction('update_ssh')" class="text-left px-4 py-3 bg-blue-900/20 hover:bg-blue-900/40 border border-blue-500/30 rounded-xl transition group">
                        <span class="block text-[10px] text-blue-400 font-orbitron">SECURITY</span><span class="text-xs font-bold text-white">UPDATE SSH</span>
                    </button>
                    <button onclick="doAction('update_firewall')" class="text-left px-4 py-3 bg-purple-900/20 hover:bg-purple-900/40 border border-purple-500/30 rounded-xl transition group">
                        <span class="block text-[10px] text-purple-400 font-orbitron">SECURITY</span><span class="text-xs font-bold text-white">UPDATE FIREWALL</span>
                    </button>
                </div>
            </div>

            <!-- Right Column: Query & Lists -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Deep Query Test -->
                <div class="glass p-5 rounded-2xl space-y-4">
                    <h2 class="text-sm font-orbitron text-blue-400 border-b border-white/10 pb-2">DEEP QUERY TEST</h2>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="domain-input" placeholder="Enter domain..." class="flex-1 bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-2 text-xs text-white focus:outline-none focus:border-blue-500 transition">
                            <select id="qtype-input" class="bg-slate-900/50 border border-slate-700 rounded-lg px-2 py-2 text-[10px] text-white focus:outline-none">
                                <option value="A">A</option>
                                <option value="AAAA">AAAA</option>
                                <option value="MX">MX</option>
                                <option value="TXT">TXT</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="runDig()" id="dig-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-orbitron text-[10px] py-2 rounded-lg transition shadow-lg shadow-blue-900/20">EXECUTE QUERY</button>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="doActionWithDomain('blacklist')" class="bg-red-900/40 hover:bg-red-900/60 text-red-400 border border-red-500/30 font-orbitron text-[10px] py-2 rounded-lg transition">BLACKLIST</button>
                                <button onclick="doActionWithDomain('whitelist')" class="bg-green-900/40 hover:bg-green-900/60 text-green-400 border border-green-500/30 font-orbitron text-[10px] py-2 rounded-lg transition">WHITELIST</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IPv6 Management -->
                <div class="glass p-5 rounded-2xl space-y-4">
                    <h2 class="text-sm font-orbitron text-purple-400 border-b border-white/10 pb-2">NETWORK MANAGEMENT</h2>
                    
                    <!-- IPv4 Section -->
                    <div class="space-y-2">
                        <span class="text-[10px] text-blue-400 font-orbitron">IPV4 CONFIGURATION</span>
                        <input type="text" id="ip4-addr-input" placeholder="IP Address/Prefix (e.g. 103.68.213.74/30)" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-white focus:outline-none focus:border-blue-500">
                        <input type="text" id="ip4-gw-input" placeholder="Gateway (e.g. 103.68.213.73)" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div class="border-t border-white/5 pt-2 space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-purple-400 font-orbitron">IPV6 CONFIGURATION</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="ipv6-toggle" onchange="toggleIpv6()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <input type="text" id="ip6-addr-input" oninput="if(this.value && !document.getElementById('ipv6-toggle').checked) document.getElementById('ipv6-toggle').checked = true;" placeholder="IPv6 Address/Prefix (e.g. 2001:db8::1/64)" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-white focus:outline-none focus:border-purple-500">
                        <input type="text" id="ip6-gw-input" placeholder="IPv6 Gateway (e.g. 2001:db8::1)" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-white focus:outline-none focus:border-purple-500">
                    </div>

                    <button onclick="updateNetwork()" class="w-full py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-orbitron text-[10px] rounded-lg transition shadow-lg">APPLY NETWORK CHANGES</button>
                    <p class="text-[9px] text-red-400 text-center">Warning: Incorrect settings may disconnect the server!</p>
                </div>

                <!-- DNS Trust -->
                <div class="glass p-5 rounded-2xl space-y-4">
                    <h2 class="text-sm font-orbitron text-green-400 border-b border-white/10 pb-2">DNS TRUST</h2>
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] text-slate-400 font-orbitron">ENABLE DNS TRUST</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="trust-toggle" onchange="toggleTrust()" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <div class="space-y-2">
                        <input type="text" id="trust-ip-input" placeholder="Trust DNS IP (e.g. 1.1.1.1)" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-white focus:outline-none focus:border-green-500">
                        <button onclick="toggleTrust()" class="w-full py-2 bg-green-600/20 hover:bg-green-600/40 border border-green-500/30 rounded-lg text-[10px] font-orbitron text-white transition">UPDATE TRUST DNS</button>
                    </div>
                </div>

                <!-- Cache Info -->
                <div class="glass p-5 rounded-2xl">
                    <h2 class="text-sm font-orbitron text-blue-400 border-b border-white/10 pb-2 mb-4">CACHE MANAGEMENT</h2>
                    <button onclick="doAction('clear_cache')" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl border border-white/5 transition flex flex-col items-center">
                        <span class="text-xs font-bold">FLUSH DNS CACHE</span>
                        <span class="text-[9px] text-slate-500 font-orbitron">PURGE ALL RECORDS</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- AUTH FUNCTIONS ---
        async function attemptLogin() {
            const passwordInput = document.getElementById('login-password');
            const password = passwordInput.value.trim(); // Trim any accidental spaces
            const btn = document.getElementById('login-btn');
            const error = document.getElementById('login-error');
            
            btn.disabled = true;
            btn.innerText = 'VERIFYING...';
            error.classList.add('hidden');

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (res.ok) {
                    document.getElementById('login-modal').classList.add('hidden');
                    updateMetrics();
                    setInterval(updateMetrics, 5000);
                    setInterval(updateTraffic, 3000);
                } else {
                    error.classList.remove('hidden');
                }
            } catch (e) {
                error.innerText = 'CONNECTION ERROR';
                error.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = 'UNLOCK SYSTEM';
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.reload();
        }

        function openPasswordModal() {
            document.getElementById('password-modal').classList.remove('hidden');
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }

        async function submitNewPassword() {
            const newPwd = document.getElementById('new-password').value;
            const confirmPwd = document.getElementById('confirm-password').value;

            if (!newPwd || newPwd.length < 4) {
                alert('Password too short (min 4 chars)');
                return;
            }
            if (newPwd !== confirmPwd) {
                alert('Passwords do not match');
                return;
            }

            try {
                const res = await fetch('/api/change_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_password: newPwd })
                });
                
                if (res.ok) {
                    alert('Password updated successfully!');
                    closePasswordModal();
                } else {
                    const data = await res.json();
                    alert('Update failed: ' + data.message);
                }
            } catch (e) {
                alert('Connection error');
            }
        }

        // Add enter key listener for login
        document.getElementById('login-password')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        const ctx = document.getElementById('trafficChart').getContext('2d');
        const trafficChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Queries', data: [], borderColor: '#00f2ff', backgroundColor: 'rgba(0, 242, 255, 0.05)', borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } }, x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } } }, plugins: { legend: { display: false } } }
        });

        let metricsInterval, trafficInterval;

        async function updateMetrics() {
            // Check auth first
            try {
                const authRes = await fetch('/api/check_auth');
                const authData = await authRes.json();
                if (!authData.authenticated) {
                    document.getElementById('login-modal').classList.remove('hidden');
                    return; 
                } else {
                    document.getElementById('login-modal').classList.add('hidden');
                }
            } catch (e) {
                console.error("Auth check failed", e);
                return;
            }

            try {
                const res = await fetch('/api/status');
                if (res.status === 401) {
                    document.getElementById('login-modal').classList.remove('hidden');
                    return;
                }
                const data = await res.json();
                updateElementStatus('dnsmasq', data.dnsmasq);
                updateElementStatus('unbound', data.unbound);
                updateElementStatus('guardian', data.guardian);
                updateElementStatus('security', data.security.flood_protection && data.security.connection_limit);
                updateElementStatus('iptables', data.iptables);

                // Update Guardian Logs if available
                if (data.security?.guardian_logs && data.security.guardian_logs.length > 0) {
                    const logs = data.security.guardian_logs.join('');
                    document.getElementById('guardian-logs').innerText = logs;
                    document.getElementById('guardian-logs-container').classList.remove('hidden');
                } else {
                    const container = document.getElementById('guardian-logs-container');
                    if (container) container.classList.add('hidden');
                }

                updateMetricValue('cpu', data.metrics.cpu);
                updateMetricValue('ram', data.metrics.ram);
                updateMetricValue('perf', data.metrics.dns_perf);

                // Pre-fill Network Form if empty
                if (!document.getElementById('ip4-addr-input').value) {
                    document.getElementById('ip4-addr-input').value = data.network?.ip4 || '';
                    document.getElementById('ip4-gw-input').value = data.network?.ip4_gw || '';
                    document.getElementById('ip6-addr-input').value = data.network?.ip6 || '';
                    document.getElementById('ip6-gw-input').value = data.network?.ip6_gw || '';
                    document.getElementById('ipv6-toggle').checked = data.network?.ipv6_enabled || false;
                    
                    // Pre-fill DNS Trust
                    document.getElementById('trust-ip-input').value = data.trust?.ip || '';
                    document.getElementById('trust-toggle').checked = data.trust?.enabled || false;
                }

                // Pre-fill Whitelist if empty
                if (!document.getElementById('whitelist-input').value && data.security?.whitelist) {
                    document.getElementById('whitelist-input').value = data.security.whitelist.join('\n');
                }
                
                // Fetch logs and traffic if first run
                if (!window.firstRunDone) {
                    fetchLogs();
                    updateTraffic();
                    window.firstRunDone = true;
                }
            } catch (e) { console.error(e); }
            
            // Schedule next update
            setTimeout(updateMetrics, 5000);
        }

        async function updateTraffic() {
            try {
                const res = await fetch('/api/traffic');
                if (res.status === 401) return;
                const data = await res.json();
                trafficChart.data.labels = data.map(d => d.time);
                trafficChart.data.datasets[0].data = data.map(d => d.queries);
                trafficChart.update('none');
            } catch (e) { console.error(e); }
            
            setTimeout(updateTraffic, 3000);
        }

        function updateMetricValue(id, val) {
            document.getElementById('metric-' + id).innerText = val;
            document.getElementById('bar-' + id).style.width = val + '%';
        }

        function updateElementStatus(id, isActive) {
            const el = document.getElementById('status-' + id);
            if (!el) return;
            el.innerText = isActive ? 'ACTIVE' : 'OFFLINE';
            el.className = 'text-[10px] font-orbitron ' + (isActive ? 'status-on' : 'status-off');
        }

        async function runDig() {
            const domain = document.getElementById('domain-input').value;
            const qtype = document.getElementById('qtype-input').value;
            if (!domain) return;
            const btn = document.getElementById('dig-btn');
            const modal = document.getElementById('dig-modal');
            const resultDisplay = document.getElementById('dig-modal-result');
            const subtitle = document.getElementById('dig-modal-subtitle');
            
            btn.disabled = true; 
            btn.innerText = 'QUERYING...';
            
            try {
                const res = await fetch('/api/dig', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({domain, qtype}) 
                });
                
                const data = await res.json();
                modal.classList.remove('hidden');
                
                if (res.ok) {
                    resultDisplay.innerText = data.result;
                    resultDisplay.classList.remove('text-red-400');
                    subtitle.innerText = 'DEEP INSPECTION SUCCESS: ' + domain.toUpperCase();
                    subtitle.classList.remove('text-red-400');
                    subtitle.classList.add('text-blue-400');
                } else {
                    resultDisplay.innerText = 'ERROR: ' + (data.message || 'Query failed');
                    resultDisplay.classList.add('text-red-400');
                    subtitle.innerText = 'INSPECTION FAILED';
                    subtitle.classList.remove('text-blue-400');
                    subtitle.classList.add('text-red-400');
                }
            } catch (e) { 
                modal.classList.remove('hidden');
                resultDisplay.innerText = 'CONNECTION ERROR';
                resultDisplay.classList.add('text-red-400');
                subtitle.innerText = 'NETWORK ERROR';
                subtitle.classList.add('text-red-400');
            } finally { 
                btn.disabled = false; 
                btn.innerText = 'EXECUTE QUERY'; 
            }
        }

        function closeDigModal() {
            document.getElementById('dig-modal').classList.add('hidden');
        }

        async function changeDnsIp() {
            const dns_ip = document.getElementById('dns-ip-input').value;
            if (!dns_ip) return;
            if (!confirm('CHANGE UPSTREAM DNS TO: ' + dns_ip + '?')) return;
            try { 
                await fetch('/api/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({type: 'change_dns', dns_ip}) }); 
                alert('Upstream DNS Updated');
            } catch (e) { alert('Failed to update DNS'); }
        }

        async function toggleIpv6() {
            const enabled = document.getElementById('ipv6-toggle').checked;
            try {
                const response = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'toggle_ipv6', enabled })
                });
                const result = await response.json();
                alert('IPv6 ' + (enabled ? 'Enabled' : 'Disabled'));
                updateMetrics();
            } catch (e) {
                alert('Failed to toggle IPv6');
            }
        }

        async function toggleTrust() {
            const trust_enabled = document.getElementById('trust-toggle').checked;
            const trust_ip = document.getElementById('trust-ip-input').value;
            
            if (trust_enabled && !trust_ip) {
                alert('Please enter Trust DNS IP first!');
                document.getElementById('trust-toggle').checked = false;
                return;
            }

            try {
                const response = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'toggle_trust', trust_enabled, trust_ip })
                });
                const result = await response.json();
                alert('DNS Trust ' + (trust_enabled ? 'Enabled (' + trust_ip + ')' : 'Disabled'));
                updateMetrics();
            } catch (e) {
                alert('Failed to update DNS Trust');
            }
        }

        async function updateNetwork() {
            const ip4_addr = document.getElementById('ip4-addr-input').value;
            const ip4_gw = document.getElementById('ip4-gw-input').value;
            const ip6_addr = document.getElementById('ip6-addr-input').value;
            const ip6_gw = document.getElementById('ip6-gw-input').value;
            const ipv6_enabled = document.getElementById('ipv6-toggle').checked;

            if (!ip4_addr || !ip4_gw) {
                alert('IPv4 Address and Gateway are required!');
                return;
            }

            if (!confirm('WARNING: Changing network settings may disconnect the server. Proceed?')) return;

            const btn = event.target;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'APPLYING CHANGES...';

            try {
                const response = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'update_network',
                        ip4_addr,
                        ip4_gw,
                        ip6_addr,
                        ip6_gw,
                        ipv6_enabled
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Network settings updated successfully.');
                    // Force refresh network info
                    document.getElementById('ip4-addr-input').value = ''; 
                    updateMetrics();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (e) {
                alert('Failed to update network settings: ' + e);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function updateWhitelist() {
            const whitelist = document.getElementById('whitelist-input').value;
            if (!confirm('CONFIRM GLOBAL WHITELIST UPDATE?')) return;
            try {
                const response = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'update_whitelist', whitelist })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Whitelist updated and firewall applied.');
                    updateMetrics();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (e) {
                alert('Failed to update whitelist');
            }
        }

        async function doAction(type) {
            if (!confirm('CONFIRM SYSTEM COMMAND: ' + type.toUpperCase() + '?')) return;
            try { await fetch('/api/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({type}) }); updateMetrics(); alert('Command Executed'); } catch (e) { alert('Command failed'); }
        }

        async function doActionWithDomain(type) {
            const domain = document.getElementById('domain-input').value;
            if (!domain) { alert('Please enter a domain first'); return; }
            if (!confirm('CONFIRM ' + type.toUpperCase() + ' FOR: ' + domain + '?')) return;
            try { await fetch('/api/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({type, domain}) }); alert(type.toUpperCase() + ' Applied'); } catch (e) { alert('Action failed'); }
        }

        async function fetchLogs() {
            try { const res = await fetch('/api/logs'); const data = await res.json(); document.getElementById('logs-content').innerText = data.logs || 'No recent logs'; } catch (e) { }
        }

        // Initialize
        updateMetrics();
        // Intervals are now managed within updateMetrics and attemptLogin
    </script>
</body>
</html>
